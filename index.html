<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>منصة حصيف · Hasseef Platform — Single File v31_pro</title>
<style>
:root{ --green:#5AA044; --green-soft:#F2FAEC; --gold:#F8BE43; --gold-soft:#FFF7E5; --dark:#222; --gray:#6B7280; --gray-soft:#F7F9FC; --bg:#fff; }
*{box-sizing:border-box}
html{scroll-behavior:smooth}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Cairo,Arial,sans-serif;background:var(--bg);color:var(--dark)}
.container{max-width:1200px;margin:0 auto;padding:0 16px}
header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:saturate(150%) blur(8px);border-bottom:1px solid rgba(0,0,0,.06)}
nav a{color:var(--dark);text-decoration:none;font-size:14px;padding:8px 10px;border-radius:12px}
nav a:hover{background:var(--gray-soft)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:#fff;cursor:pointer;font-size:14px}
.btn-primary{background:var(--green);color:#fff;border-color:var(--green)}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;background:var(--gold-soft)}
.card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:16px;padding:16px}
.grid{display:grid;gap:16px}
.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
h1{font-size:32px;margin:0} h2{font-size:24px;margin:0} h3{font-size:18px;margin:0}
small{color:var(--gray)}
hr{border:0;border-top:1px solid rgba(0,0,0,.08);margin:16px 0}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid rgba(0,0,0,.16);border-radius:12px;background:#fff;font-size:14px}
.kpi{display:flex;flex-direction:column;gap:6px}
.kpi .value{font-weight:800;font-size:24px}
.kpi .caption{font-size:12px;color:var(--gray)}
.progress{height:10px;background:var(--gray-soft);border-radius:999px;overflow:hidden}
.progress .bar{height:100%;background:var(--green);width:40%;transition:width .6s ease}
footer{padding:24px 0;color:var(--gray)}
.hero{padding:56px 0;background:linear-gradient(180deg,#ffffff 0%,#F7F9FC 100%)}
.brand{display:flex;align-items:center;gap:10px}
.brand span{font-weight:900}
.logo-grid{display:grid;gap:12px;grid-template-columns:repeat(6,minmax(0,1fr))}
.logo-box{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center}
.kpi-grid{display:grid;gap:12px;grid-template-columns:repeat(3,minmax(0,1fr))}
.tabbar{display:flex;flex-wrap:wrap;gap:8px}
.tabbar .tab{border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:8px 12px;background:#fff;cursor:pointer;font-size:13px}
.tab.active{background:var(--green);color:#fff;border-color:var(--green)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:60}
.modal .dialog{background:#fff;border-radius:16px;padding:18px;max-width:520px;width:100%}
.modal.show{display:flex}
.lang-toggle{display:inline-flex;gap:6px;border:1px solid rgba(0,0,0,.12);padding:4px;border-radius:12px}
.lang-toggle button{border:0;background:transparent;padding:6px 10px;border-radius:8px;cursor:pointer}
.lang-toggle button.active{background:var(--green-soft);color:var(--dark);font-weight:700}
.hc *{outline:1px dashed rgba(0,0,0,.25);outline-offset:2px}
.dark body{background:#101418;color:#1f2937}
.dark .card, .dark header, .dark .btn, .dark input, .dark select, .dark textarea{background:#ffffff}
@media (max-width:768px){ .grid-3{grid-template-columns:1fr} .kpi-grid{grid-template-columns:1fr} .logo-grid{grid-template-columns:repeat(3,1fr)} }
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;gap:12px;justify-content:space-between;padding:10px 0;">
    <div class="brand">
      <svg width="42" height="42" viewBox="0 0 64 64" aria-label="Hasseef" role="img"><circle cx="32" cy="32" r="30" fill="#5AA044"/><text x="32" y="38" font-size="20" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif">ح</text></svg>
      <span>منصة حصيف</span>
    </div>
    <nav style="display:flex;align-items:center;gap:10px">
      <a href="#overview" data-i="nav_overview">نظرة عامة</a>
      <a href="#accounts" data-i="nav_accounts">الحسابات</a>
      <a href="#partners" data-i="nav_partners">الشركاء</a>
      <a href="#dashboard" data-i="nav_dashboard">لوحة</a>
      <a href="mailto:info@talbiya.sa" class="btn">info@talbiya.sa</a>
      <div class="lang-toggle">
        <button id="lang-ar" class="active">عربي</button>
        <button id="lang-en">EN</button>
      </div>
    </nav>
  </div>
</header>

<section class="hero" id="overview">
  <div class="container">
    <div class="grid grid-2" style="align-items:center">
      <div>
        <h1 data-i="hero_title">منصة حصيف — الممكن الوطني للشراكات والأثر</h1>
        <p style="color:var(--gray)" data-i="hero_sub">
          نموذج قيادي تفاعلي يبرز قيمة المنصة ضمن مستهدفات رؤية 2030 ويعرض الحسابات والخدمات والمؤشرات الحية.
        </p>
        <div style="display:flex;gap:8px;margin-top:10px">
          <a href="#dashboard" class="btn btn-primary" data-i="cta_open_dashboard">افتح اللوحة</a>
          <button id="toggleHC" class="btn" data-i="cta_high_contrast">تباين مرتفع</button>
        </div>
        <div style="margin-top:14px">
          <small data-i="hero_note">هذا النموذج يعمل محليًا دون اتصال ويصلح للعرض الرسمي.</small>
        </div>
      </div>
      <div class="card">
        <div class="kpi-grid">
          <div class="kpi">
            <div class="caption" data-i="kpi1">نمو التوظيف</div>
            <div class="value" id="kpi-employment">+18%</div>
            <div class="progress"><div class="bar" id="bar-1" style="width:62%"></div></div>
          </div>
          <div class="kpi">
            <div class="caption" data-i="kpi2">تكامل الشركاء</div>
            <div class="value" id="kpi-integration">92%</div>
            <div class="progress"><div class="bar" id="bar-2" style="width:50%"></div></div>
          </div>
          <div class="kpi">
            <div class="caption" data-i="kpi3">مشاريع مدعومة</div>
            <div class="value" id="kpi-projects">1,240</div>
            <div class="progress"><div class="bar" id="bar-3" style="width:40%"></div></div>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <label data-i="profile_label">المنظور:</label>
          <select id="kpiProfile">
            <option value="national">وطني</option>
            <option value="hail">منطقة حائل</option>
            <option value="private">القطاع الخاص</option>
            <option value="nonprofit">القطاع غير الربحي</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="container" id="accounts" style="padding:32px 0">
  <h2 style="margin-bottom:12px" data-i="acc_title">حسابات المنصة والخدمات</h2>
  <p style="color:var(--gray)" data-i="acc_sub">يعرض هذا القسم الحسابات (حسب الدور) والخدمات الرئيسة لكل حساب.</p>
  <div id="rolesGrid" class="grid grid-3"></div>
</section>

<section class="container" id="partners" style="padding:8px 0 24px">
  <h2 style="margin-bottom:12px" data-i="partners_title">الشركاء الاستراتيجيون</h2>
  <div class="logo-grid">
    <div class="logo-box"><svg width="100" height="40" viewBox="0 0 100 40"><rect width="100" height="40" rx="8" fill="#F7F9FC"/><text x="50" y="26" text-anchor="middle" font-family="Arial" font-size="14" fill="#6B7280">أداء (ADAA)</text></svg></div>
    <div class="logo-box"><svg width="100" height="40" viewBox="0 0 100 40"><rect width="100" height="40" rx="8" fill="#F7F9FC"/><text x="50" y="26" text-anchor="middle" font-family="Arial" font-size="14" fill="#6B7280">Vision 2030</text></svg></div>
    <div class="logo-box"><svg width="100" height="40" viewBox="0 0 100 40"><rect width="100" height="40" rx="8" fill="#F7F9FC"/><text x="50" y="26" text-anchor="middle" font-family="Arial" font-size="14" fill="#6B7280">Hasseef</text></svg></div>
    <div class="logo-box"><svg width="100" height="40" viewBox="0 0 100 40"><rect width="100" height="40" rx="8" fill="#F7F9FC"/><text x="50" y="26" text-anchor="middle" font-family="Arial" font-size="14" fill="#6B7280">Talbiya</text></svg></div>
    <div class="logo-box"><span style="opacity:.6">Monsha'at</span></div>
    <div class="logo-box"><span style="opacity:.6">SDB</span></div>
  </div>
</section>

<section id="dashboard" style="padding:32px 0 48px;background:#fff">
  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2 data-i="dash_title">لوحتي</h2>
      <div><small data-i="dash_user">مرحبًا، <b id="userName">ضيف</b> · الدور: <b id="userRole">—</b></small></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div id="service-workspace" class="card" style="display:none;background:#fff"></div>

      <h3 style="margin:4px 0 10px" data-i="dash_services">خدمات الحساب</h3>
      <div id="role-services" class="grid grid-3"></div>
      <hr/>
      <div class="tabbar">
        <button class="tab active" data-tab="tab-overview" data-i="tab_overview">نظرة عامة</button>
        <button class="tab" data-tab="tab-initiatives" data-i="tab_initiatives">مبادراتي</button>
        <button class="tab" data-tab="tab-opps" data-i="tab_opps">فرص</button>
      </div>
      <div style="margin-top:12px">
        <div id="tab-overview">
          <div class="grid kpi-grid">
            <div class="card"><small data-i="dash_stat1">عدد المبادرات</small><div class="value" id="stat-initiatives">0</div></div>
            <div class="card"><small data-i="dash_stat2">طلبات قيد المراجعة</small><div class="value" id="stat-pending">0</div></div>
            <div class="card"><small data-i="dash_stat3">فرص مقترحة</small><div class="value" id="stat-opps">0</div></div>
          </div>
        </div>
        <div id="tab-initiatives" style="display:none">
          <form id="form-initiative" class="grid grid-2">
            <input placeholder="اسم المبادرة" required/>
            <select><option>تعليمي</option><option>ثقافي</option><option>اجتماعي</option><option>اقتصادي</option></select>
            <textarea class="grid-col-span-2" placeholder="وصف مختصر" required></textarea>
            <div class="grid grid-3">
              <input placeholder="الجمهور المستهدف"/>
              <input placeholder="القيمة المقترحة"/>
              <input placeholder="القنوات"/>
            </div>
            <button class="btn btn-primary" style="margin-top:6px" data-i="btn_save">حفظ</button>
          </form>
          <div style="margin-top:12px">
            <h3 data-i="list_title">قائمة المبادرات</h3>
            <div id="list-initiatives" class="grid"></div>
          </div>
        </div>
        <div id="tab-opps" style="display:none">
          <small style="color:var(--gray)" data-i="opps_note">(تجريبي) فرص مقترحة بناءً على دورك ومنطقتك.</small>
          <div id="list-opps" class="grid grid-2" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<footer class="container">
  <div style="display:flex;align-items:center;justify-content:space-between">
    <small>© 2025 Hasseef</small>
    <div style="display:flex;gap:8px">
      <button id="toggleTheme" class="btn">Dark</button>
      <button id="toggleHC2" class="btn">HC</button>
    </div>
  </div>
</footer>

<!-- Auth Modals -->
<div id="modal-login" class="modal">
  <div class="dialog">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 data-i="login_title">تسجيل دخول</h3>
      <button class="btn" onclick="closeModal('modal-login')">×</button>
    </div>
    <form id="loginForm" class="grid">
      <input name="emailOrName" placeholder="البريد الإلكتروني أو الاسم" required/>
      <div class="grid grid-2">
        <input name="password" type="password" placeholder="كلمة المرور"/>
        <select name="role">
          <option value="individual">فرد</option>
          <option value="private">قطاع خاص</option>
          <option value="nonprofit">قطاع غير ربحي</option>
          <option value="university">جامعة</option>
          <option value="government">حكومة</option>
          <option value="emirate">إمارة</option>
          <option value="funder">مانح</option>
          <option value="partner">شريك استراتيجي</option>
        </select>
      </div>
      <button class="btn btn-primary" data-i="btn_login">دخول</button>
    </form>
  </div>
</div>

<div id="modal-signup" class="modal">
  <div class="dialog">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 data-i="signup_title">تسجيل حساب</h3>
      <button class="btn" onclick="closeModal('modal-signup')">×</button>
    </div>
    <form id="signupForm" class="grid">
      <input name="name" placeholder="الاسم الكامل" required/>
      <input name="email" type="email" placeholder="البريد الإلكتروني" required/>
      <select name="role" required>
        <option value="individual">فرد</option>
        <option value="private">قطاع خاص</option>
        <option value="nonprofit">قطاع غير ربحي</option>
        <option value="university">جامعة</option>
        <option value="government">حكومة</option>
        <option value="emirate">إمارة</option>
        <option value="funder">مانح</option>
        <option value="partner">شريك استراتيجي</option>
      </select>
      <input name="region" placeholder="المنطقة (اختياري)"/>
      <input name="password" type="password" placeholder="كلمة المرور" required/>
      <button class="btn btn-primary" data-i="btn_create">إنشاء حساب</button>
    </form>
  </div>
</div>

<script>
// i18n
const i18n = {
  ar:{nav_overview:"نظرة عامة",nav_accounts:"الحسابات",nav_partners:"الشركاء",nav_dashboard:"لوحة",
      hero_title:"منصة حصيف — الممكن الوطني للشراكات والأثر",
      hero_sub:"نموذج قيادي تفاعلي يبرز قيمة المنصة ضمن مستهدفات رؤية 2030 ويعرض الحسابات والخدمات والمؤشرات الحية.",
      cta_open_dashboard:"افتح اللوحة",cta_high_contrast:"تباين مرتفع",
      hero_note:"هذا النموذج يعمل محليًا دون اتصال ويصلح للعرض الرسمي.",
      kpi1:"نمو التوظيف",kpi2:"تكامل الشركاء",kpi3:"مشاريع مدعومة",
      profile_label:"المنظور:",acc_title:"حسابات المنصة والخدمات",
      acc_sub:"يعرض هذا القسم الحسابات (حسب الدور) والخدمات الرئيسة لكل حساب.",
      partners_title:"الشركاء الاستراتيجيون",
      dash_title:"لوحتي",dash_user:"مرحبًا، ",
      dash_services:"خدمات الحساب",
      tab_overview:"نظرة عامة",tab_initiatives:"مبادراتي",tab_opps:"فرص",
      dash_stat1:"عدد المبادرات",dash_stat2:"طلبات قيد المراجعة",dash_stat3:"فرص مقترحة",
      list_title:"قائمة المبادرات",opps_note:"(تجريبي) فرص مقترحة بناءً على دورك ومنطقتك.",
      login_title:"تسجيل دخول",btn_login:"دخول",signup_title:"تسجيل حساب",btn_create:"إنشاء حساب"},
  en:{nav_overview:"Overview",nav_accounts:"Accounts",nav_partners:"Partners",nav_dashboard:"Dashboard",
      hero_title:"Hasseef Platform — National Enabler for Partnerships & Impact",
      hero_sub:"A leadership-grade interactive demo highlighting value under Vision 2030 targets, with accounts, services, and live KPIs.",
      cta_open_dashboard:"Open Dashboard",cta_high_contrast:"High Contrast",
      hero_note:"This demo runs fully offline and is suitable for executive briefings.",
      kpi1:"Employment Growth",kpi2:"Partner Integration",kpi3:"Supported Projects",
      profile_label:"Profile:",acc_title:"Platform Accounts & Services",
      acc_sub:"Accounts (by role) and their primary services.",
      partners_title:"Strategic Partners",
      dash_title:"My Dashboard",dash_user:"Welcome, ",
      dash_services:"Account Services",
      tab_overview:"Overview",tab_initiatives:"My Initiatives",tab_opps:"Opportunities",
      dash_stat1:"Initiatives",dash_stat2:"Pending Requests",dash_stat3:"Suggested Opportunities",
      list_title:"Initiatives List",opps_note:"(Demo) Suggested opportunities by your role and region.",
      login_title:"Sign In",btn_login:"Sign In",signup_title:"Create Account",btn_create:"Create Account"}
};
let currentLang='ar';
function applyLang(lang){
  currentLang = lang;
  document.documentElement.lang = lang;
  document.documentElement.dir = (lang==='ar'?'rtl':'ltr');
  document.querySelectorAll('[data-i]').forEach(el=>{
    const key = el.getAttribute('data-i'); el.textContent = i18n[lang][key] || el.textContent;
  });
  document.getElementById('lang-ar').classList.toggle('active', lang==='ar');
  document.getElementById('lang-en').classList.toggle('active', lang==='en');
}
document.getElementById('lang-ar').onclick = ()=>applyLang('ar');
document.getElementById('lang-en').onclick = ()=>applyLang('en');

// Theme & HC
document.getElementById('toggleTheme').onclick = ()=> document.documentElement.classList.toggle('dark');
document.getElementById('toggleHC').onclick = ()=> document.documentElement.classList.toggle('hc');
document.getElementById('toggleHC2').onclick = ()=> document.documentElement.classList.toggle('hc');

// Modals
function openModal(id){ document.getElementById(id).classList.add('show'); }
function closeModal(id){ document.getElementById(id).classList.remove('show'); }

// KPIs data
const KPIS = {
  national:{employment:18, integration:92, projects:1240},
  hail:{employment:22, integration:88, projects:260},
  private:{employment:12, integration:95, projects:740},
  nonprofit:{employment:9, integration:86, projects:340}
};

// ROLES
const ROLES_DATA = {
  roles: [
    {id:"emirate", ar:"إمارة المنطقة", en:"Emirate", services:[
      {id:"regional-dashboard", ar:"لوحة المنطقة", en:"Regional Dashboard"},
      {id:"approve-initiatives", ar:"اعتماد مبادرات", en:"Approve Initiatives"},
      {id:"prince-sponsorship", ar:"رعاية سمو الأمير", en:"Prince Sponsorship"},
      {id:"security-screening", ar:"المسح الأمني للمتحدثين/الفعاليات", en:"Security Screening"}
    ]},
    {id:"government", ar:"جهة حكومية", en:"Government", services:[
      {id:"challenge-request", ar:"طرح تحديات/طلب حلول", en:"Challenge Request"},
      {id:"approve-events", ar:"اعتماد الفعاليات", en:"Approve Events"},
      {id:"request-solutions", ar:"طلب حلول وتنفيذ", en:"Request Solutions"},
      {id:"gov-projects", ar:"مشاريع حكومية مرتبطة 6/27/96", en:"Gov Projects (6/27/96)"}
    ]},
    {id:"private", ar:"قطاع خاص", en:"Private Sector", services:[
      {id:"csr-report", ar:"تقرير المسؤولية CSR", en:"CSR Report"},
      {id:"sponsor", ar:"رعاية فعالية/مشروع", en:"Sponsor"},
      {id:"jobs", ar:"نشر وظائف", en:"Jobs"},
      {id:"facilities-market", ar:"مرافق الشركة (تأجير/استئجار)", en:"Facilities Market"}
    ]},
    {id:"nonprofit", ar:"قطاع غير ربحي", en:"Nonprofit", services:[
      {id:"publish-opps", ar:"نشر فرص التطوع/التدريب", en:"Publish Opportunities"},
      {id:"manage-projects", ar:"إدارة المبادرات والمشاريع", en:"Manage Projects"},
      {id:"funding-intake", ar:"استقبال تمويل/تبرعات", en:"Funding Intake"},
      {id:"npo-facilities", ar:"مرافق الجمعية", en:"Facilities"}
    ]},
    {id:"university", ar:"جامعة", en:"University", services:[
      {id:"academic-review", ar:"استشارات علمية", en:"Academic Advisory"},
      {id:"coop-training", ar:"تدريب تعاوني", en:"Co-op Training"},
      {id:"research-listing", ar:"نشر أبحاث قابلة للتطبيق", en:"Applied Research"},
      {id:"uni-facilities", ar:"مرافق أكاديمية", en:"Academic Facilities"}
    ]},
    {id:"funder", ar:"جهة تمويل/مانح", en:"Funder", services:[
      {id:"grant-criteria", ar:"معايير المنح/التمويل", en:"Grant Criteria"},
      {id:"grant-portfolio", ar:"محفظة المنح", en:"Grant Portfolio"},
      {id:"find-projects", ar:"مطابقة مشاريع ومعايير", en:"Match Projects"},
      {id:"impact-reports", ar:"تقارير أثر التمويل", en:"Impact Reports"}
    ]},
    {id:"individual", ar:"فرد", en:"Individual", services:[
      {id:"add-initiative", ar:"إضافة مبادرة فردية", en:"Add Initiative"},
      {id:"volunteer", ar:"التطوع وتوثيق الساعات", en:"Volunteering"},
      {id:"jobs-list", ar:"فرص وظيفية", en:"Jobs"},
      {id:"skills-check", ar:"فحص الميول والمهارات (تجريبي)", en:"Skills Check (beta)"}
    ]},
    {id:"partner", ar:"شريك استراتيجي", en:"Strategic Partner", services:[
      {id:"partner-oversight", ar:"واجهة إشرافية للشريك", en:"Partner Oversight"},
      {id:"partner-kpis", ar:"مؤشرات نجاح مخصصة", en:"Custom KPIs"},
      {id:"policy-notices", ar:"تنبيهات سياسات/تكاملات", en:"Policy/Integrations Alerts"}
    ]}
  ]
};

// Local state
const App = {
  users: JSON.parse(localStorage.getItem('users')||'[]'),
  user: JSON.parse(localStorage.getItem('user')||'null'),
  initiatives: JSON.parse(localStorage.getItem('initiatives')||'[]'),
  opps: [{title:'تطوع في ملتقى الشباب', kind:'اجتماعي'},
         {title:'برنامج حاضنة مشاريع ناشئة', kind:'اقتصادي'},
         {title:'مبادرة نادي قرّاء الجامعات', kind:'تعليمي'}],
  save(){ localStorage.setItem('users', JSON.stringify(this.users));
          localStorage.setItem('user', JSON.stringify(this.user));
          localStorage.setItem('initiatives', JSON.stringify(this.initiatives)); }
};

// RBAC
const RBAC = {
  emirate:{ project:"vceda--", challenge:"vceda--", funding:"v---- -", event:"vceda--", permit:"vceda-d", facility:"vceda-d" },
  government:{ project:"vceda--", challenge:"vceda--", funding:"vceda-d", event:"vceda-d", permit:"vceda-d" },
  private:{ project:"vce---d", challenge:"v-----", funding:"v-cef-d", event:"vce--d", job:"vce--d" },
  nonprofit:{ project:"vce---d", challenge:"vce--d", funding:"v-cef-d", event:"vce--d", volunteer:"vce--d" },
  university:{ project:"vce-a-d", challenge:"v--a--", research:"vce-a-d", training:"vce--d", consult:"vce--d" },
  funder:{ funding:"vceaf--", project:"v--a--", sponsor:"v--a--" },
  individual:{ project:"vce---d", volunteer:"vce---", job:"v---- -" },
  partner:{ partner:"vcea--d", kpi:"v-----" }
};
function can(role, component, action){
  const map = {view:0, create:1, edit:2, approve:3, fund:4, assign:5, delete:6};
  const p = (RBAC[role]||{})[component]; if(!p) return false;
  const ch = p[map[action]]; return !!(ch && ch!=='-');
}

// Component cards
const CardTemplates = {
  project:(p)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>مشروع: ${p.name||'—'}</b>
        <span class="badge">[${p.stage||'مسودة'}]</span>
      </div>
      <small>الجهة: ${p.owner||'—'} | المؤشر الوطني: ${p.kpi||'—'}</small>
      <p style="margin:.5rem 0;color:var(--gray)">${p.desc||''}</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn"${!can(App.user?.role,'project','fund')?' disabled':''}>طلب تمويل</button>
        <button class="btn"${!can(App.user?.role,'project','approve')?' disabled':''}>إصدار تقرير أثر</button>
        <button class="btn">إرفاق مستند</button>
      </div>
    </div>`,
  challenge:(c)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>تحدّي: ${c.title||'—'}</b>
        <span class="badge">[${c.state||'مفتوح'}]</span>
      </div>
      <small>القطاع: ${c.sector||'—'} | إغلاق: ${c.deadline||'—'}</small>
      <p style="margin:.5rem 0;color:var(--gray)">${c.desc||''}</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn">تقديم حل</button>
        <button class="btn">طرح استفسار</button>
        <button class="btn">متابعة</button>
      </div>
    </div>`,
  funding:(f)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>تمويل: ${f.project||'—'}</b>
        <span class="badge">[${f.state||'قيد التدقيق'}]</span>
      </div>
      <small>المانح: ${f.funder||'—'} | النوع: ${f.kind||'—'}</small>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="btn"${!can(App.user?.role,'funding','approve')?' disabled':''}>اعتماد الدفعة</button>
        <button class="btn">طلب مستند</button>
        <button class="btn"${!can(App.user?.role,'funding','delete')?' disabled':''}>تعليق/رفض</button>
      </div>
    </div>`
};

// Roles grid
(function renderRoles(){
  const grid = document.getElementById('rolesGrid');
  ROLES_DATA.roles.forEach(role=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><b>${role.ar}</b> · <small>${role.en}</small></div>
        <span class="badge">Role</span>
      </div>
      <ul style="margin:10px 0 0;padding:0;list-style:none">
        ${role.services.map(s=>`<li style="padding:6px 0;display:flex;justify-content:space-between"><span>${s.ar} · <small>${s.en}</small></span><button class="btn" data-role="${role.id}" data-srv="${s.id}">فتح</button></li>`).join('')}
      </ul>`;
    grid.appendChild(card);
  });
  grid.querySelectorAll('button[data-srv]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      if(!App.user){ openModal('modal-login'); return; }
      openService(btn.dataset.srv);
      location.hash = '#dashboard';
    });
  });
})();

// KPIs behavior
(function initKPIs(){
  function setProfile(p){
    const b = KPIS[p]||KPIS.national;
    document.getElementById('kpi-employment').textContent = `+${b.employment}%`;
    document.getElementById('kpi-integration').textContent = `${b.integration}%`;
    document.getElementById('kpi-projects').textContent = b.projects.toLocaleString('en-US');
    document.getElementById('bar-1').style.width = (50 + Math.random()*30)+'%';
    document.getElementById('bar-2').style.width = (40 + Math.random()*30)+'%';
    document.getElementById('bar-3').style.width = (30 + Math.random()*30)+'%';
  }
  document.getElementById('kpiProfile').addEventListener('change', e=> setProfile(e.target.value));
  setProfile('national');
})();

// Tabs
document.querySelectorAll('.tabbar .tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tabbar .tab').forEach(b=>b.classList.remove('active'));
    t.classList.add('active');
    ['tab-overview','tab-initiatives','tab-opps'].forEach(id=> document.getElementById(id).style.display='none');
    document.getElementById(t.dataset.tab).style.display='block';
  });
});

// Auth
document.getElementById('loginForm').addEventListener('submit', e=>{
  e.preventDefault();
  const emailOrName = e.target.emailOrName.value.trim();
  const pw = e.target.password.value.trim();
  const role = e.target.role.value;
  if(emailOrName.includes('@') && pw){
    const u = App.users.find(u=>u.email===emailOrName && u.pw===btoa(pw));
    if(!u){ alert('بيانات الدخول غير صحيحة'); return; }
    App.user = {name:u.name, email:u.email, role:u.role, region:u.region||''};
  } else {
    App.user = {name:emailOrName || 'ضيف', role};
  }
  App.save();
  document.getElementById('userName').textContent = App.user.name;
  document.getElementById('userRole').textContent = App.user.role;
  closeModal('modal-login');
  location.hash = '#dashboard';
  renderServices(); updateStats(); renderOpps(); renderList();
});

document.getElementById('signupForm').addEventListener('submit', e=>{
  e.preventDefault();
  const fd = new FormData(e.target); const data = Object.fromEntries(fd.entries());
  if(App.users.some(u=>u.email===data.email)){ alert('البريد مسجّل'); return; }
  data.pw = btoa(data.password); delete data.password;
  App.users.push(data);
  App.user = {name:data.name,email:data.email,role:data.role,region:data.region||''};
  App.save();
  document.getElementById('userName').textContent = App.user.name;
  document.getElementById('userRole').textContent = App.user.role;
  closeModal('modal-signup');
  location.hash = '#dashboard';
  renderServices(); updateStats(); renderOpps(); renderList();
});

// Services per role
const servicesByRole = {
  individual:[{id:'add-initiative',title:'إضافة مبادرة'},{id:'volunteer',title:'التطوع'},{id:'jobs-list',title:'وظائف'}],
  private:[{id:'csr-report',title:'تقرير المسؤولية CSR'},{id:'sponsor',title:'رعاية فعالية/مشروع'},{id:'jobs',title:'نشر وظائف'},{id:'facilities-market',title:'مرافق الشركة'}],
  nonprofit:[{id:'publish-opps',title:'نشر فرص'},{id:'manage-projects',title:'إدارة المشاريع'},{id:'funding-intake',title:'استقبال تمويل'}],
  university:[{id:'academic-review',title:'استشارات علمية'},{id:'coop-training',title:'تدريب تعاوني'},{id:'research-listing',title:'أبحاث تطبيقية'}],
  government:[{id:'challenge-request',title:'طرح تحديات'},{id:'approve-events',title:'اعتماد الفعاليات'},{id:'request-solutions',title:'طلب حلول'},{id:'gov-projects',title:'مشاريع حكومية 6/27/96'}],
  emirate:[{id:'regional-dashboard',title:'لوحة المنطقة'},{id:'approve-initiatives',title:'اعتماد مبادرات'},{id:'prince-sponsorship',title:'رعاية سمو الأمير'},{id:'security-screening',title:'مسح أمني'}],
  funder:[{id:'grant-criteria',title:'معايير المنح'},{id:'grant-portfolio',title:'محفظة المنح'},{id:'find-projects',title:'مطابقة مشاريع'},{id:'impact-reports',title:'تقارير الأثر'}],
  partner:[{id:'partner-oversight',title:'واجهة الشريك'},{id:'partner-kpis',title:'مؤشرات الشريك'},{id:'policy-notices',title:'تنبيهات السياسات'}]
};

function renderServices(){
  const grid = document.getElementById('role-services'); if(!grid) return;
  grid.innerHTML = '';
  if(!App.user){ grid.innerHTML = '<small style="color:var(--gray)">سجّل الدخول أولًا لعرض الخدمات</small>'; return; }
  (servicesByRole[App.user.role]||[]).forEach(s=>{
    const d=document.createElement('div'); d.className='card';
    d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><b>${s.title}</b><button class="btn" data-srv="${s.id}">فتح</button></div>`;
    d.querySelector('button').onclick = ()=>openService(s.id);
    grid.appendChild(d);
  });
}

// Workspace per service
function openService(id){
  const box = document.getElementById('service-workspace');
  box.style.display='block';
  let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <b>${id}</b><button class="btn" id="closeWS">×</button>
  </div>`;
  switch(id){
    case 'add-initiative':
      html += `<form id="ws-add-init" class="grid grid-2">
        <input placeholder="اسم المبادرة" required/>
        <select><option>تعليمي</option><option>ثقافي</option><option>اجتماعي</option><option>اقتصادي</option></select>
        <textarea class="grid-col-span-2" placeholder="وصف مختصر" required></textarea>
        <div class="grid grid-3">
          <select><option>هدف 1..6</option></select>
          <select><option>هدف فرعي 1..27</option></select>
          <select><option>هدف تفصيلي 1..96</option></select>
        </div>
        <button class="btn btn-primary">حفظ</button>
      </form>`; break;
    case 'csr-report':
      html += `<form id="ws-csr" class="grid grid-3">
        <input placeholder="المنشأة" required/>
        <input placeholder="الفترة (2025-Q4)" required/>
        <input placeholder="حجم الإنفاق (ر.س)" required/>
        <textarea class="grid-col-span-3" placeholder="ملاحظات/ربط مشاريع (6/27/96)"></textarea>
        <button class="btn btn-primary grid-col-span-3">توليد مسودة</button>
      </form>`; break;
    case 'sponsor':
      html += `<form id="ws-sponsor" class="grid grid-2">
        <input placeholder="اسم الفعالية/المشروع" required/>
        <input placeholder="الجهة المنظمة" required/>
        <input placeholder="التاريخ"/>
        <input placeholder="المدينة"/>
        <button class="btn btn-primary grid-col-span-2">إرسال طلب الرعاية</button>
      </form>`; break;
    case 'publish-opps':
      html += `<form id="ws-opp" class="grid grid-3">
        <input placeholder="عنوان الفرصة" required/>
        <select><option>وظيفة</option><option>تطوع</option><option>تدريب</option></select>
        <input placeholder="القطاع/الفئة"/>
        <textarea class="grid-col-span-3" placeholder="وصف مختصر"></textarea>
        <button class="btn btn-primary grid-col-span-3">نشر</button>
      </form>`; break;
    case 'manage-projects':
      html += `<div id="ws-projects" class="grid"></div>
      <form id="ws-add-proj" class="grid grid-3">
        <input placeholder="اسم المشروع" required/>
        <select><option>قيد التخطيط</option><option>قيد التنفيذ</option><option>مكتمل</option></select>
        <button class="btn btn-primary">إضافة</button>
      </form>`; break;
    case 'academic-review':
      html += `<form id="ws-acad" class="grid">
        <input placeholder="عنوان الدراسة" required/>
        <textarea placeholder="ملخص"></textarea>
        <button class="btn btn-primary">إصدار مسودة اعتماد</button>
      </form>`; break;
    case 'coop-training':
      html += `<form id="ws-coop" class="grid grid-2">
        <input placeholder="المسمّى" required/>
        <input placeholder="المدة (أسابيع)"/>
        <button class="btn btn-primary grid-col-span-2">نشر</button>
      </form>`; break;
    case 'approve-events':
      html += `<div id="ws-events" class="grid"></div>`; break;
    case 'challenge-request':
      html += `<form id="ws-challenge" class="grid grid-2">
        <input placeholder="عنوان التحدي" required/>
        <textarea class="grid-col-span-2" placeholder="التفاصيل"></textarea>
        <button class="btn btn-primary grid-col-span-2">نشر التحدي</button>
      </form>`; break;
    case 'request-solutions':
      html += `<form id="ws-sol" class="grid grid-2">
        <input placeholder="عنوان الطلب" required/>
        <textarea class="grid-col-span-2" placeholder="الاحتياج والتوقيت"></textarea>
        <button class="btn btn-primary grid-col-span-2">إرسال</button>
      </form>`; break;
    case 'regional-dashboard':
      html += `<div class="grid grid-3">
        <div class="card"><small>مبادرات</small><div class="value" id="rg-init">0</div></div>
        <div class="card"><small>وظائف/تطوع</small><div class="value" id="rg-opps">0</div></div>
        <div class="card"><small>مشاريع</small><div class="value" id="rg-proj">0</div></div>
      </div>`; break;
    case 'approve-initiatives':
      html += `<div id="ws-approve" class="grid"></div>`; break;
    case 'prince-sponsorship':
      html += `<form id="ws-prince" class="grid grid-2">
        <input placeholder="اسم الجهة/الفعالية" required/>
        <input placeholder="التاريخ"/>
        <textarea class="grid-col-span-2" placeholder="موجز الأثر المتوقع (ربط 6/27/96)"></textarea>
        <button class="btn btn-primary grid-col-span-2">طلب رعاية سمو الأمير</button>
      </form>`; break;
    case 'security-screening':
      html += `<form id="ws-sec" class="grid">
        <input placeholder="اسم المتحدث/الفعالية" required/>
        <input placeholder="الهوية/السجل (اختياري)"/>
        <textarea placeholder="روابط أو ملاحظات داعمة"></textarea>
        <button class="btn btn-primary">بدء المسح الأمني (تجريبي)</button>
      </form>`; break;
    case 'grant-criteria':
      html += `<div class="card"><b>معايير المنح</b><p style="color:var(--gray)">ارفع ملفات المعايير أو حدّد أوزان التقييم.</p></div>`; break;
    case 'grant-portfolio':
      html += `<div class="grid grid-3">
        <div class="card"><small>إجمالي التمويل</small><div class="value">1.2م</div></div>
        <div class="card"><small>مشاريع نشطة</small><div class="value">7</div></div>
        <div class="card"><small>مكتملة</small><div class="value">12</div></div>
      </div>`; break;
    case 'find-projects':
      html += `<form id="ws-find" class="grid grid-3">
        <select><option>تعليمي</option><option>ثقافي</option><option>اجتماعي</option><option>اقتصادي</option></select>
        <input placeholder="المنطقة"/>
        <button class="btn btn-primary">بحث</button>
      </form><div id="ws-results" class="grid" style="margin-top:8px"></div>`; break;
    case 'partner-oversight':
      html += `<div class="grid grid-3">
        <div class="card"><small>مؤشر 1</small><div class="value">—</div></div>
        <div class="card"><small>مؤشر 2</small><div class="value">—</div></div>
        <div class="card"><small>برامج نشطة</small><div class="value">—</div></div>
      </div>
      <small style="color:var(--gray)">هذه الصفحة تُهيّأ لكل شريك (أداء، منشآت، بنك التنمية …).</small>`; break;
    default:
      html += `<small>الخدمة غير معرّفة بعد.</small>`;
  }
  box.innerHTML = html;
  document.getElementById('closeWS').onclick = ()=>{ box.style.display='none'; box.innerHTML=''; };

  if(document.getElementById('ws-opp')){
    document.getElementById('ws-opp').onsubmit = (e)=>{ e.preventDefault(); alert('تم النشر (تجريبي)'); };
  }
  if(document.getElementById('ws-events')){
    const host=document.getElementById('ws-events'); ['مهرجان صيفي','ملتقى التطوع','معرض الجامعات'].forEach(n=>{
      const c=document.createElement('div'); c.className='card';
      c.innerHTML=`<div style="display:flex;justify-content:space-between"><div>${n}</div><div><button class="btn">قبول</button> <button class="btn">رفض</button></div></div>`;
      host.appendChild(c);
    });
  }
  if(document.getElementById('ws-approve')){
    const host=document.getElementById('ws-approve'); (App.initiatives||[]).forEach(it=>{
      if(it.status==='قيد المراجعة'){
        const c=document.createElement('div'); c.className='card';
        c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div>${it.name}</div><button class="btn btn-primary">اعتماد</button></div>`;
        c.querySelector('button').onclick=()=>{ it.status='معتمد'; App.save(); c.remove(); alert('تم الاعتماد'); };
        host.appendChild(c);
      }
    });
  }
}

App.initiatives = App.initiatives || [];

// Initiatives handlers
document.getElementById('form-initiative').addEventListener('submit', e=>{
  e.preventDefault();
  const [name,cat,desc,b1,b2,b3] = Array.from(e.target.querySelectorAll('input,select,textarea')).map(el=>el.value);
  const item = {id:Date.now(), name, cat, desc, blocks:{b1,b2,b3}, status:'قيد المراجعة'};
  App.initiatives.push(item); App.save();
  e.target.reset(); renderList(); updateStats(); alert('تم الحفظ');
});

function renderList(){
  const wrap = document.getElementById('list-initiatives'); if(!wrap) return; wrap.innerHTML='';
  if(!App.initiatives.length){ wrap.innerHTML = '<small style="color:var(--gray)">لا توجد مبادرات بعد.</small>'; return; }
  App.initiatives.slice().reverse().forEach(it=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><b>${it.name}</b><span class="badge">${it.status}</span></div>
      <small style="color:var(--gray)">${it.cat} • ${it.desc}</small>
      <div class="grid grid-3">
        <div class="card">${it.blocks.b1||'-'}</div>
        <div class="card">${it.blocks.b2||'-'}</div>
        <div class="card">${it.blocks.b3||'-'}</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" data-act="approve">اعتماد</button>
        <button class="btn" data-act="delete">حذف</button>
      </div>`;
    card.querySelector('[data-act="delete"]').onclick=()=>{ App.initiatives = App.initiatives.filter(x=>x.id!==it.id); App.save(); renderList(); updateStats(); };
    card.querySelector('[data-act="approve"]').onclick=()=>{ it.status='معتمد'; App.save(); renderList(); };
    wrap.appendChild(card);
  });
}

function updateStats(){
  const total = App.initiatives.length;
  const pending = App.initiatives.filter(i=>i.status==='قيد المراجعة').length;
  const opps = App.opps.length;
  document.getElementById('stat-initiatives').textContent = total;
  document.getElementById('stat-pending').textContent = pending;
  document.getElementById('stat-opps').textContent = opps;
}
function renderOpps(){
  const wrap = document.getElementById('list-opps'); if(!wrap) return; wrap.innerHTML='';
  App.opps.forEach(o=>{ const d=document.createElement('div'); d.className='card';
    d.innerHTML=`<b>${o.title}</b><small style="color:var(--gray)">${o.kind}</small>`; wrap.appendChild(d); });
}

// Extra national KPIs
function updateNationalKpis(){
  const funded = 37, volunteeringOpen = 122, licensedEvents = 18;
  const host = document.querySelector('#tab-overview .grid.kpi-grid');
  const add = (label,val)=>{ const c=document.createElement('div'); c.className='card';
    c.innerHTML=`<small>${label}</small><div class="value">${val}</div>`; host.appendChild(c); };
  add('المشاريع الممولة', funded);
  add('فرص التطوع المفتوحة', volunteeringOpen);
  add('الفعاليات المرخصة', licensedEvents);
}

// Init
(function init(){
  if(App.user){ document.getElementById('userName').textContent = App.user.name; document.getElementById('userRole').textContent = App.user.role; }
  renderServices(); renderList(); updateStats(); renderOpps();
  updateNationalKpis();
  applyLang('ar');
})();
</script>
</body>
</html>
